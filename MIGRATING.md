# Migrating from 3.x to 4.x
- Ensure you have the latest 3.x version of the dependency upgrade tool installed globally
  - `yarn global add @parameter1/base-cms-dependency-tool@v3.28.1`
- Update _all_ website `docker-compose.yml` and `Dockerfile` files to use `node:14.21` image
  - For GitHub actions, update the `node-version` in `.github/workflows/node-ci.yml` to `14.21`
- Run the dependency tool using the latest flag: `p1-basecms-dependencies upgrade --latest`
  - If trying to upgrade to a pre-release, also include the `--prereleases` flag
- Optional: you may want to clear your `node_modules` before running yarn: run `rm -rf node_modules` from the website root
- Run yarn install _in the new node:14 docker image_ via `./scripts/yarn.sh` or by `docker-compose run --rm --entrypoint yarn terminal` from the project root
  - `node-sass` may hang or error when compiling binaries in the final stage of the install. if this happens, delete any `yarn.lock` entries where `node-sass@` is less than 4.14.1 and re-install
- Once the new packages are installed, some Babel versions may be mismatched -- delete all entries in `yarn.lock` that match regex `/^"@babel\//` then re-run yarn install above
- Update browserslist entries via `npx browserslist@latest --update-db`
- Update relative node_module `@import` declarations in `.scss` files to their absolute counterparts. For example:
  - `@import "../../node_modules/bootstrap/scss/mixins"` would become `@import "bootstrap/scss/mixins";`
  - `@import "../../node_modules/@parameter1/base-cms-marko-web-theme-monorail/scss/core";` would become `@import "@parameter1/base-cms-marko-web-theme-monorail/scss/core";`
  - note: the number of relative parent paths does not matter... so `../` and `../../` and `../../../` etc all need to be removed.
  - the quickest way to fix this is with a find and replace in `.scss` files with the following regex: `@import ".*\/node_modules\/` and replace with an empty string.
- Remove any references to components `<marko-web-deferred-script-loader-init />` and `<marko-web-deferred-script-loader-load />`. These are now included in core and do not need to be in the websites.
- Each website's `yarn dev` and `yarn build` scripts _should_ still work as expected, as the new CLI assumes that marko templates need to be compiled from `../packages` (assuming a standard site working directory of `sites/domain.com`). If this needs to be adjusted, change the site's `dev` script `--compile-dir` option
- Marko files from `@parameter1 `packages (found in `node_modules`) are now compiled on build/publish. As such the compiled files will already exist in `node_modules`. As such, there's not need to watch or compile `node_modules` packages. The drawback is that you _cannot_ directly change `.marko` files found in `node_modules` without re-compiling the changed file.
